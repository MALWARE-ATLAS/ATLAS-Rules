meta:
  name: "iso_research"
  description: "A rule for ISO research project."
  author: "r00tten"
  version: "1.0"

scripts:
    create_dir: "aW1wb3J0IG9zCmltcG9ydCB0aW1lCgpkZWYgY3JlYXRlX2RpcihwYXRoOiBzdHIpIC0+IHN0cjoKICAgIHRpbWVzdGFtcCA9IHRpbWUudGltZSgpCiAgICBiYXNlbmFtZSA9IG9zLnBhdGguYmFzZW5hbWUocGF0aCkKCiAgICBkaXJfbmFtZSA9ICJ7fV97fSIuZm9ybWF0KGJhc2VuYW1lLCBpbnQodGltZXN0YW1wKSkKICAgIG9zLm1rZGlyKGRpcl9uYW1lKQoKICAgIHJldHVybiBkaXJfbmFtZQ=="
    iso_extract: "aW1wb3J0IGlvCmltcG9ydCBvcwppbXBvcnQgc3lzCmltcG9ydCBweWNkbGliCmltcG9ydCBjb2xsZWN0aW9ucwoKZGVmIGlzb19leHRyYWN0KGRhdGE6IGJ5dGVzLCB0YXJnZXRfcGF0aDogc3RyPSIuIikgLT4gbGlzdDoKICAgIHJlc3VsdCA9IFtdCiAgICBmaWxlX2xpa2UgPSBpby5CeXRlc0lPKGRhdGEpCgogICAgaXNvID0gcHljZGxpYi5QeUNkbGliKCkKICAgIGlzby5vcGVuX2ZwKGZpbGVfbGlrZSkKCiAgICBpZiBpc28uaGFzX3VkZigpOgogICAgICAgIHBhdGhuYW1lID0gJ3VkZl9wYXRoJwogICAgZWxpZiBpc28uaGFzX3JvY2tfcmlkZ2UoKToKICAgICAgICBwYXRobmFtZSA9ICdycl9wYXRoJwogICAgZWxpZiBpc28uaGFzX2pvbGlldCgpOgogICAgICAgIHBhdGhuYW1lID0gJ2pvbGlldF9wYXRoJwogICAgZWxzZToKICAgICAgICBwYXRobmFtZSA9ICdpc29fcGF0aCcKCiAgICByb290X2VudHJ5ID0gaXNvLmdldF9yZWNvcmQoKip7cGF0aG5hbWU6ICIvIn0pCgogICAgZGlycyA9IGNvbGxlY3Rpb25zLmRlcXVlKFtyb290X2VudHJ5XSkKICAgIHdoaWxlIGRpcnM6CiAgICAgICAgZGlyX3JlY29yZCA9IGRpcnMucG9wbGVmdCgpCiAgICAgICAgaWRlbnRfdG9faGVyZSA9IGlzby5mdWxsX3BhdGhfZnJvbV9kaXJyZWNvcmQoZGlyX3JlY29yZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb2NrcmlkZ2U9cGF0aG5hbWUgPT0gJ3JyX3BhdGgnKQogICAgICAgIHJlbG5hbWUgPSBpZGVudF90b19oZXJlW2xlbigiLyIpOl0KICAgICAgICBpZiByZWxuYW1lIGFuZCByZWxuYW1lWzBdID09ICIvIjoKICAgICAgICAgICAgcmVsbmFtZSA9IHJlbG5hbWVbMTpdCiAgICAgICAgaWYgZGlyX3JlY29yZC5pc19kaXIoKToKICAgICAgICAgICAgaWYgcmVsbmFtZSAhPSAnJzoKICAgICAgICAgICAgICAgIG9zLm1ha2VkaXJzKG9zLnBhdGguam9pbih0YXJnZXRfcGF0aCwgcmVsbmFtZSkpCiAgICAgICAgICAgIGNoaWxkX2xpc3RlciA9IGlzby5saXN0X2NoaWxkcmVuKCoqe3BhdGhuYW1lOiBpZGVudF90b19oZXJlfSkKCiAgICAgICAgICAgIGZvciBjaGlsZCBpbiBjaGlsZF9saXN0ZXI6CiAgICAgICAgICAgICAgICBpZiBjaGlsZCBpcyBOb25lIG9yIGNoaWxkLmlzX2RvdCgpIG9yIGNoaWxkLmlzX2RvdGRvdCgpOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBkaXJzLmFwcGVuZChjaGlsZCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBkaXJfcmVjb3JkLmlzX3N5bWxpbmsoKToKICAgICAgICAgICAgICAgIGZ1bGxwYXRoID0gb3MucGF0aC5qb2luKHRhcmdldF9wYXRoLCByZWxuYW1lKQogICAgICAgICAgICAgICAgbG9jYWxfZGlyID0gb3MucGF0aC5kaXJuYW1lKGZ1bGxwYXRoKQogICAgICAgICAgICAgICAgbG9jYWxfbGlua19uYW1lID0gb3MucGF0aC5iYXNlbmFtZShmdWxscGF0aCkKICAgICAgICAgICAgICAgIG9sZF9kaXIgPSBvcy5nZXRjd2QoKQogICAgICAgICAgICAgICAgb3MuY2hkaXIobG9jYWxfZGlyKQogICAgICAgICAgICAgICAgb3Muc3ltbGluayhkaXJfcmVjb3JkLnJvY2tfcmlkZ2Uuc3ltbGlua19wYXRoKCksIGxvY2FsX2xpbmtfbmFtZSkKICAgICAgICAgICAgICAgIG9zLmNoZGlyKG9sZF9kaXIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBpc28uZ2V0X2ZpbGVfZnJvbV9pc28ob3MucGF0aC5qb2luKHRhcmdldF9wYXRoLCByZWxuYW1lKSwgKip7cGF0aG5hbWU6IGlkZW50X3RvX2hlcmV9KQogICAgICAgICAgICAgICAgcmVzdWx0LmFwcGVuZChvcy5wYXRoLmpvaW4ob3MuZ2V0Y3dkKCksICh0YXJnZXRfcGF0aCArIGlkZW50X3RvX2hlcmUpKSkKICAgIAogICAgaXNvLmNsb3NlKCkKCiAgICByZXR1cm4gcmVzdWx0"
    find_lnk: "aW1wb3J0IHJlCgpkZWYgZmluZF9sbmsoYXJyOiBsaXN0KSAtPiBzdHI6CiAgICByZXN1bHQgPSAiIgoKICAgIHBhdHRyID0gcmUuY29tcGlsZShyIlwubG5rJCIpCgogICAgZm9yIGkgaW4gYXJyOgogICAgICAgIGlmIHJlLnNlYXJjaChwYXR0ciwgaSk6CiAgICAgICAgICAgIHJlc3VsdCA9IGkKICAgICAgICAgICAgYnJlYWsKCiAgICByZXR1cm4gcmVzdWx0"
    get_lnk_target: "aW1wb3J0IExua1BhcnNlMwogCmRlZiBnZXRfbG5rX3RhcmdldChwYXRoOiBzdHIpIC0+IGRpY3Q6ICAKICAgIHJlc3VsdCA9IHt9CiAgICB0YXJnZXQgPSAiIgogICAgY29tbWFuZCA9ICIiCgogICAgd2l0aCBvcGVuKHBhdGgsICJyYiIpIGFzIGZpbGU6CiAgICAgICAgbG5rID0gTG5rUGFyc2UzLmxua19maWxlKGZpbGUpCiAgICAgICAgbG5rX2pzb24gPSBsbmsuZ2V0X2pzb24oKQoKICAgICAgICBpZiBsbmtfanNvbi5nZXQoInRhcmdldCIsICIiKSAhPSAiIjoKICAgICAgICAgICAgZm9yIGkgaW4gbG5rX2pzb25bInRhcmdldCJdWyJpdGVtcyJdOgogICAgICAgICAgICAgICAgaWYgaVsiY2xhc3MiXSA9PSAiUm9vdCBGb2xkZXIiIG9yXAogICAgICAgICAgICAgICAgaVsiY2xhc3MiXSA9PSAiVm9sdW1lIEl0ZW0iOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBlbGlmIGlbImNsYXNzIl0gPT0gIkZpbGUgZW50cnkiOgogICAgICAgICAgICAgICAgICAgIGlmIGlbImZsYWdzIl0gPT0gIklzIGRpcmVjdG9yeSI6CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldCArPSBpWyJwcmltYXJ5X25hbWUiXSArICIvIgogICAgICAgICAgICAgICAgICAgIGVsaWYgaVsiZmxhZ3MiXSA9PSAiSXMgZmlsZSI6CiAgICAgICAgICAgICAgICAgICAgICAgIHRhcmdldCArPSBpWyJwcmltYXJ5X25hbWUiXQogICAgICAgIGVsaWYgbG5rX2pzb24uZ2V0KCJleHRyYSIsICIiKSAhPSAiIjoKICAgICAgICAgICAgdGFyZ2V0ID0gbG5rX2pzb25bImV4dHJhIl1bIkVOVklST05NRU5UQUxfVkFSSUFCTEVTX0xPQ0FUSU9OX0JMT0NLIl1bInRhcmdldF9hbnNpIl0KICAgICAgICAgICAgCiAgICAgICAgY29tbWFuZCA9IGxua19qc29uWyJkYXRhIl0uZ2V0KCJjb21tYW5kX2xpbmVfYXJndW1lbnRzIiwgIiIpCiAgICAgICAgCiAgICAgICAgcmVzdWx0WyJ0YXJnZXQiXSA9IHRhcmdldAogICAgICAgIHJlc3VsdFsiY29tbWFuZCJdID0gY29tbWFuZAoKICAgIHJldHVybiByZXN1bHQ="

chain:
    s1:
        input: $param.file
        func: file_read_bin

    s1_5:
        input:
            - $scripts.create_dir
            - $param.file
        func: python_executor

    s2:
        input: 
            - $scripts.iso_extract
            - $s1
            - $s1_5
        func: python_executor

    s3:
        input:
            - $scripts.find_lnk 
            - $s2
        func: python_executor
    
    s4:
        input:
            - $scripts.get_lnk_target
            - $s3
        func: python_executor